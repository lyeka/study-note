# 持久化

Redis支持两种数据持久化

- RDB
- AOF



## RDB

RDB就是全量备份，将内存中的数据以紧凑的二进制的形式存储到硬盘中，也就是等同于快照，在redis重启的时候再加载这份快照恢复数据至内存。触发RDB持久化可分为手动和自动，持久化命令分为两种

- save——阻塞redis服务器，停止执行客户端的命名，知道RDB执行完成
- bgsave——fork一个子进程来完成RDB，主线程仍然执行客户端的指令



### 写时复制

在使用非阻塞RDB持久化时，redis使用了操作系统的多进程COW机制

![img](https://user-gold-cdn.xitu.io/2018/5/18/163711de3e2b6cb8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

主要原理就是父子进程在开始共享内存中的代码段与数据段，如果父进程对数据段进行了修改，数据段对应的页会被复制一份出来，所以对于子进程来说，其共享的内存从开始到结束是没有发生变化的。



### 优缺点

优点

- 重启加载效率高



缺点

- 持久化效率低
- RDB文件还有版本格式兼容问题

## AOF

AOF日志会将对内存产生了修改的指令写入到日志中（先执行指令，再写日志），重启redis时会重放AOF日志中的指令来恢复数据。随着运行时间的增长，AOF会日益增大，所以需要日志瘦身。



### fsync

日志并不是直接写入到文件中的，而是先写入内核分配的缓存中，随后内核再异步落盘，这个落盘可以手动使用`fsync`来主动触发，但是频率过高会导致效率低下，频率太低数据丢失可能性加大。



### 优缺点

优点

- 持久化效率高

缺点

- 重载效率低



## 混合持久化

redis4.0后提供了混个持久化选择，可以使用RDB和AOF配合来作持久化。