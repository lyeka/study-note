# 主从同步

## CAP

CAP是指导分布式系统设计的一个重要定理，包括三个指标

- Consistency（一致性）
    - 多个子系统之间的状态（数据）一致
- Availability（可用性）
    - 对于请求作出响应
- Partition tolerance（分区容错）
    - 子系统之间的通信（可能存在失败）



CAP指出，三个指标无法同时实现。

对于分区容错，一般认为实际上是必定会发生，所以一般分布式系统一般为CP或者AP（这点待深入探究）



## BASE

> BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。

BASE是包括下面三个概念，

- Basically Available（基本可用）
    - 允许损失部分可用性
        - 响应时间上的损失
        - 功能上的损失(降级页面)
- Soft state（软状态）
    - 子系统状态（数据）存在中间状态，并且中间状态不会影响系统的整体可用性
- Eventually consistent（最终一致性）
    - 子系统在一段时间状态（数据）同步后，最终会达成一致



## Redis主从同步

话说虽然叫主从同步，但是redis主从通常从是用作备份，类似于主备同步概念。如传统意义上的主从，主和从都是要承担一部分读写的，如mysql中通常主写从读。



### 增量同步

类型于AOF，主节点将对内存产生修改的指令存入buffer（在内存而不是日志文件），然后异步将buffer中指令流同步给从节点。但内存中的buffer是有限的，超出限额后将从头开始覆盖前面的内容（buffer为定长环形数组)。



### 快照同步

类似与RDB，首先在主库上进行bgsave将内存快照到磁盘文件，在将文件内容同步到从节点，从节点清空内存，全量加载文件，加载完毕后在与主节点进行增量同步（指的是从节点加载期间主节点加入buffer的指令）。

但是如果快照同步时间过长，或者buffer太小（加载期间主节点存储的指令超出buffer上限制），会导致快照同步后无法进行增量同步，从而又开始快照同步，这可能会导致死循环。

解决办法：合理调整buffer大小参数



**无盘复制**

快照同步时，会有很多文件IO操作，从而对系统负载产生影响，redis2.8.18后开始支持无盘复制，即主服务器直接通过套接字将快照内容发送给从服务器，从服务器还是和之前一样，先将内容存储到磁盘中，再一次性加载。



### Wait

redis的复制是异步进行的，reids3.0后可以使用wait指令来使其变为同步复制（来加强一致性）。





ref

- [CAP 定理的含义](https://www.ruanyifeng.com/blog/2018/07/cap.html)

- [谈谈 ACID、CAP 和 BASE](http://guleilab.com/2019/05/05/acid-cap-base/)

