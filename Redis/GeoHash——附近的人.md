# GeoHash

Redis在3.2版本后增加了地理位置GEO模块，可以用来实现附近的人此类的功能。



## 实现原理

主要是通过经纬度的地理位置坐标算出两点之间的距离，简单一点的计算使用勾股定理即可，考虑到地球经纬度密度不一样，经度范围值(-180， 180]，纬度范围(-90,90]，精确一点的话还要加权计算。



Redis的GeoHash算法是将二维的经纬度数据映射到一维的整数，当所有元素都挂载到一条直线上时，距离靠近的二维坐标在一维映射点上也会相应的靠近。



**映射算法**

> 它将整个地球看成一个二维平面，然后划分成了一系列正方形的方格，就好比围棋棋盘。所有的地图元素坐标都将放置于唯一的方格中。方格越小，坐标越精确。然后对这些方格进行整数编码，越是靠近的方格编码越是接近。那如何编码呢？一个最简单的方案就是切蛋糕法。设想一个正方形的蛋糕摆在你面前，二刀下去均分分成四块小正方形，这四个小正方形可以分别标记为 00,01,10,11 四个二进制整数。然后对每一个小正方形继续用二刀法切割一下，这时每个小小正方形就可以使用 4bit 的二进制整数予以表示。然后继续切下去，正方形就会越来越小，二进制整数也会越来越长，精确度就会越来越高。
>
> 编码之后，每个地图元素的坐标都将变成一个整数，通过这个整数可以还原出元素的坐标，整数越长，还原出来的坐标值的损失程度就越小。对于「附近的人」这个功能而言，损失的一点精确度可以忽略不计。
>
> GeoHash 算法会继续对这个整数做一次 base32 编码 (0-9,a-z 去掉 a,i,l,o 四个字母) 变成一个字符串。在 Redis 里面，经纬度使用 52 位的整数进行编码，放进了 zset 里面，zset 的 value 是元素的 key，score 是 GeoHash 的 52 位整数值。zset 的 score 虽然是浮点数，但是对于 52 位的整数值，它可以无损存储。



![img](https://user-gold-cdn.xitu.io/2018/7/4/1646397a223e2019?imageslim)

## 基本使用

- `geoadd`——添加元素
- `geodist`——计算元素之间距离
- `geopos`——获取元素位置
- `geohash`——获取元素hash值
- `georadiusbymember`——查询指定元素附近其他元素
- `georadius`——根据坐标位置获取附近元素



geo存储上实际为zset，故删除可以使用`zrem`