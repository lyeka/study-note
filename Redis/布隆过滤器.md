# 布隆过滤器

布隆过滤器可以视为一个不太精准的集合，可以判断元素是否在集合中，但是这个判定是有误差的，对于存在于集合的元素，存在判定一定准确，对于不在集合的元素，对于其在集合的判定会有误差。也就是类似宁可错杀一千，不可放过一人的意思。所以可以应用在黑名单过滤，推荐文章去重等方面。与集合相比，布隆过滤器占用的空间节省90%以上。



布隆过滤器不是redis自带的功能，需要以插件的形式加载到redis server中，官方提供的布隆过滤器插件需要redis4.0+版本才可用。



## 基本使用

**默认布隆过滤器配置**

不需要显示创建key

- `bf.add`——添加元素
- `bf.exist`——查询元素是否存在
- `bf.madd`——一次添加多个元素
- `bf.mexists`——一次查询多个元素是否存在



**自定义布隆过滤器**

需要手动创建key

- `bf.reserve <key> [error_rate initial_size]`
    - initial_size——预计存放元素的个数，值越大，占用空间越大，估值过小会影响准确率。默认100。
    - error_rate——目标错误率，值越小，错误率越小，不过占用空间会越大。默认0.01。



## 原理

![img](https://user-gold-cdn.xitu.io/2018/7/4/16464301a0e26416?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

数据结构类似与位数组，添加元素时会使用多个无偏hash函数（无偏是指hash的结果比较均匀）对元素哈希得到多个数值，然后使用位数组长度分别与这些数值取模运算得到位置，将这些位置置1。

判读元素是否存在就是同样使用这些hash函数计算出对应的位，只有有一个位不为1，那这个key就不存在与集合中；如果都是1，会判定为存在，但实际上不一定存在，只是极可能存在。

上述只是粗略描述了其中的算法原理，具体待深入。



## 空间占用估计

TODO

在线计算地址——https://krisives.github.io/bloom-calculator/



## 其他应用

- 去重
- NOSQL中过滤不存在的row请求，再去磁盘查询。
- 垃圾邮件过滤
- 缓存攻击



## 其他

利用HyperLogLog的添加元素前后的基数是否相同也可以起到类似判断去重的作用，而且占用的空间非常小，但是每一次操作都会把元素给添加进去，如果只是想判断数据存不存在而又不想把数据存进去的话会不适用。





